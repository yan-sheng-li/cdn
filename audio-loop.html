<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘ç‰‡æ®µæ’­æ”¾å™¨ï¼ˆæ”¯æŒæ–‡ä»¶å¤¹ï¼‰</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 10px;
            margin: 0;
            background-color: #f8f9fa;
            transition: background 0.5s ease;
        }

        h2 {
            font-size: 1.4rem;
            text-align: center;
            animation: fadeInDown 1s ease;
        }

        /* waveform åŠ ä¸Šè½»å¾®çš„é˜´å½±å’ŒåŠ¨æ€å‘å…‰ */
        #waveform {
            width: 100%;
            height: 96px;
            margin: 10px 0;
            border: 1px solid #ccc;
            box-sizing: border-box;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.15);
            transition: box-shadow 0.3s ease;
        }

        #waveform:hover {
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.35);
        }

        input[type="file"] {
            width: 100%;
            margin: 10px 0;
            transition: transform 0.3s ease;
        }

        input[type="file"]:hover {
            transform: scale(1.02);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        button,
        select {
            padding: 10px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            flex: 1 1 45%;
            min-width: 120px;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
        }

        button:hover,
        select:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        select {
            background-color: #17a2b8;
        }

        ul#trackList {
            list-style: none;
            padding: 0;
        }

        #trackList li {
            padding: 8px 10px;
            background-color: white;
            border: 1px solid #ccc;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #trackList li:hover {
            background-color: #e9ecef;
            transform: translateX(4px);
        }

        #trackList li.playing {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            animation: pulse 1.2s infinite;
        }

        p {
            font-size: 0.9rem;
            color: #555;
            text-align: center;
            animation: fadeIn 1.2s ease;
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(0, 123, 255, 0.7);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 0 12px rgba(0, 123, 255, 0.6);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(0, 123, 255, 0.7);
            }
        }
    </style>


    <script src="https://unpkg.com/wavesurfer.js@6.6.0/dist/wavesurfer.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@6.6.0/dist/plugin/wavesurfer.regions.min.js"></script>
</head>

<body>

    <h2>ğŸµ æ‹–æ‹½é€‰æ‹©æ’­æ”¾ç‰‡æ®µï¼ˆæ”¯æŒæ–‡ä»¶å¤¹ï¼‰</h2>

    <label for="audioFile">é€‰æ‹©éŸ³é¢‘æ–‡ä»¶:</label>
    <input type="file" id="audioFile" accept="audio/*">

    <label for="folderInput">é€‰æ‹©æ–‡ä»¶å¤¹:</label>
    <input type="file" id="folderInput" webkitdirectory directory multiple>

    <div id="waveform"></div>

    <div class="controls">
        <button onclick="playRegion()">â–¶ æ’­æ”¾ç‰‡æ®µ</button>
        <button onclick="pause()">â¸ æš‚åœ</button>
        <button onclick="toggleLoop()">ğŸ” å¾ªç¯: <span id="loopStatus">å…³é—­</span></button>
        <select id="speedControl" title="æ’­æ”¾é€Ÿåº¦">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
        </select>
    </div>

    <p>ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹åï¼Œå¯ç‚¹å‡»æ›²ç›®æ’­æ”¾</p>
    <p>ğŸ“± ç©ºæ ¼é”®æ’­æ”¾/æš‚åœï¼Œå›è½¦å›åˆ°ç‰‡æ®µèµ·ç‚¹ï¼Œâ†‘â†“é”®è°ƒèŠ‚éŸ³é‡ï¼Œâ†â†’é”®å¿«è¿›/å¿«é€€ï¼ˆæ¡Œé¢ç«¯ï¼‰</p>
    <ul id="trackList"></ul>




    <script>
    // ==================== IndexedDB ç®€å•å°è£… ====================
    const DB_NAME = 'AudioPlayerDB';
    const STORE_FILES = 'files';
    const STORE_META = 'meta';
    let db = null;

    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 3);  // ç‰ˆæœ¬+1ä»¥é‡å»º

            req.onupgradeneeded = e => {
                db = e.target.result;
                if (!db.objectStoreNames.contains(STORE_FILES)) {
                    db.createObjectStore(STORE_FILES, { keyPath: 'key' });
                }
                if (!db.objectStoreNames.contains(STORE_META)) {
                    db.createObjectStore(STORE_META, { keyPath: 'key' });
                }
            };
            req.onsuccess = e => {
                db = e.target.result;
                resolve(db);
            };
            req.onerror = e => reject(e);
        });
    }

    async function saveFile(key, blob) {
        const tx = db.transaction(STORE_FILES, 'readwrite');
        await tx.objectStore(STORE_FILES).put({ key, blob });
        await tx.complete;
    }

    async function getFile(key) {
        const tx = db.transaction(STORE_FILES, 'readonly');
        const store = tx.objectStore(STORE_FILES);
        const req = store.get(key);
        return new Promise((resolve) => {
            req.onsuccess = () => resolve(req.result ? req.result.blob : null);
        });
    }

    async function saveMeta(key, value) {
        const tx = db.transaction(STORE_META, 'readwrite');
        await tx.objectStore(STORE_META).put({ key, value });
        await tx.complete;
    }

    async function getMeta(key) {
        const tx = db.transaction(STORE_META, 'readonly');
        const store = tx.objectStore(STORE_META);
        const req = store.get(key);
        return new Promise((resolve) => {
            req.onsuccess = () => resolve(req.result ? req.result.value : null);
        });
    }

    async function clearAll() {
        const tx = db.transaction([STORE_FILES, STORE_META], 'readwrite');
        await tx.objectStore(STORE_FILES).clear();
        await tx.objectStore(STORE_META).clear();
        await tx.complete;
    }
    // ===========================================================

    const supportedFormats = ['.mp3', '.wav', '.ogg', '.flac', '.m4a', '.aac', '.webm'];
    let wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#ccc',
        progressColor: '#007bff',
        height: 96,
        normalize: true,
        responsive: true,
        plugins: [WaveSurfer.regions.create()]
    });

    let region = null;
    let loopEnabled = false;
    let currentTrackIndex = null;
    let currentFileKey = null;

    // ---------- é«˜äº®å½“å‰æ’­æ”¾æ›²ç›® ----------
    function highlightCurrentTrack() {
        const listItems = document.querySelectorAll('#trackList li');
        listItems.forEach((li, i) => {
            if (i === currentTrackIndex) {
                li.classList.add('playing');
                if (!li.dataset.originalText) li.dataset.originalText = li.textContent.replace('â–¶ ', '');
                li.textContent = 'â–¶ ' + li.dataset.originalText;
            } else {
                li.classList.remove('playing');
                if (li.dataset.originalText) li.textContent = li.dataset.originalText;
            }
        });
    }

    // ---------- åŠ è½½éŸ³é¢‘ï¼ˆæ”¯æŒ Blobï¼‰ ----------
    async function loadAudioFromBlob(blob, index = null, fileKey = null) {
        const url = URL.createObjectURL(blob);
        wavesurfer.load(url);
        currentTrackIndex = index;
        currentFileKey = fileKey;
        highlightCurrentTrack();

        if (fileKey) await saveMeta('lastFileKey', fileKey);
        if (index !== null) await saveMeta('lastTrackIndex', index);
    }

    // ---------- å•ä¸ªæ–‡ä»¶é€‰æ‹© ----------
    document.getElementById('audioFile').addEventListener('change', async function () {
        const file = this.files[0];
        if (!file) return;

        const key = `single_${Date.now()}_${file.name}`;
        await saveFile(key, file);
        await saveMeta('mode', 'single');
        await saveMeta('lastFileKey', key);

        loadAudioFromBlob(file, null, key);
    });

    // ---------- æ–‡ä»¶å¤¹é€‰æ‹© ----------
    document.getElementById('folderInput').addEventListener('change', async function () {
        const files = Array.from(this.files);
        const audioFiles = files.filter(f => 
            supportedFormats.some(ext => f.name.toLowerCase().endsWith(ext))
        );

        if (audioFiles.length === 0) return;

        await clearAll();  // æ¸…ç©ºæ—§æ•°æ®

        const listContainer = document.getElementById('trackList');
        listContainer.innerHTML = '';

        // ä¿å­˜æ–‡ä»¶åæ˜ å°„ï¼ˆç”¨äºç²¾ç¡®æ¢å¤ï¼‰
        const fileNames = [];
        const fileKeys = [];

        for (let i = 0; i < audioFiles.length; i++) {
            const file = audioFiles[i];
            const key = `folder_${i}_${encodeURIComponent(file.name)}`;  // ç¼–ç æ–‡ä»¶åé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
            await saveFile(key, file);
            fileNames.push(file.webkitRelativePath || file.name);
            fileKeys.push(key);

            const li = document.createElement('li');
            li.textContent = fileNames[i];
            li.dataset.key = key;
            li.dataset.index = i;
            li.onclick = async () => {
                const blob = await getFile(key);
                if (blob) loadAudioFromBlob(blob, i, key);
            };
            listContainer.appendChild(li);
        }

        // ä¿å­˜æ˜ å°„è¡¨
        await saveMeta('folderFileNames', fileNames);
        await saveMeta('folderFileKeys', fileKeys);
        await saveMeta('mode', 'folder');
        await saveMeta('folderFileCount', audioFiles.length);

        // é»˜è®¤åŠ è½½ç¬¬ä¸€é¦–
        const firstBlob = await getFile(fileKeys[0]);
        if (firstBlob) loadAudioFromBlob(firstBlob, 0, fileKeys[0]);
    });

    // ---------- é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸Šæ¬¡çŠ¶æ€ ----------
    (async () => {
        await openDB();

        const mode = await getMeta('mode');
        if (!mode) return;

        if (mode === 'single') {
            const key = await getMeta('lastFileKey');
            if (key) {
                const blob = await getFile(key);
                if (blob) loadAudioFromBlob(blob, null, key);
            }
            return;
        }

        if (mode === 'folder') {
            const fileNames = await getMeta('folderFileNames') || [];
            const fileKeys = await getMeta('folderFileKeys') || [];
            const count = fileNames.length;

            if (count === 0) return;

            const listContainer = document.getElementById('trackList');
            listContainer.innerHTML = '';

            // ç”¨æ˜ å°„è¡¨ç²¾ç¡®é‡å»ºåˆ—è¡¨ï¼ˆæ— é‡å¤ï¼‰
            for (let i = 0; i < count; i++) {
                const key = fileKeys[i];
                const name = fileNames[i];
                const blob = await getFile(key);  // é¢„åŠ è½½blobä»¥é˜²ç‚¹å‡»æ—¶å»¶è¿Ÿ

                if (!blob) continue;

                const li = document.createElement('li');
                li.textContent = name;
                li.dataset.key = key;
                li.dataset.index = i;
                li.onclick = () => loadAudioFromBlob(blob, i, key);
                listContainer.appendChild(li);
            }

            // æ¢å¤æœ€åæ’­æ”¾çš„é‚£é¦–
            const lastIndex = await getMeta('lastTrackIndex') || 0;
            const lastKey = fileKeys[lastIndex];
            if (lastKey) {
                const blob = await getFile(lastKey);
                if (blob) {
                    currentTrackIndex = lastIndex;
                    loadAudioFromBlob(blob, lastIndex, lastKey);
                    highlightCurrentTrack();
                }
            }
        }
    })();

    // ================== åŸæœ‰åŠŸèƒ½ä»£ç ï¼ˆå¾®è°ƒä»¥å…¼å®¹ï¼‰ ==================
    wavesurfer.on('ready', () => {
        const duration = wavesurfer.getDuration();
        if (region) region.remove();
        region = wavesurfer.addRegion({
            start: 0,
            end: Math.min(10, duration),
            color: 'rgba(0, 123, 255, 0.2)',
            drag: true,
            resize: true,
            loop: loopEnabled
        });
    });

    function playRegion() {
        if (region) wavesurfer.play(region.start, region.end);
    }

    function toggleLoop() {
        loopEnabled = !loopEnabled;
        document.getElementById('loopStatus').textContent = loopEnabled ? 'å¼€å¯' : 'å…³é—­';
        if (region) region.loop = loopEnabled;
    }

    function pause() {
        wavesurfer.pause();
    }

    document.getElementById('speedControl').addEventListener('change', function () {
        wavesurfer.setPlaybackRate(parseFloat(this.value));
    });

    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
            if (wavesurfer.isPlaying()) {
                wavesurfer.pause();
            } else {
                if (region) {
                    playRegion();
                } else {
                    wavesurfer.play();
                }
            }
        }
        if (e.code === 'Enter') {
            e.preventDefault();
            if (region) wavesurfer.setCurrentTime(region.start);
        }
        if (e.code === 'ArrowUp') {
            e.preventDefault();
            wavesurfer.setVolume(Math.min(1, wavesurfer.getVolume() + 0.1));
        }
        if (e.code === 'ArrowDown') {
            e.preventDefault();
            wavesurfer.setVolume(Math.max(0, wavesurfer.getVolume() - 0.1));
        }
        if (e.code === 'ArrowRight') {
            e.preventDefault();
            const currentTime = wavesurfer.getCurrentTime();
            const duration = wavesurfer.getDuration();
            wavesurfer.setCurrentTime(Math.min(duration, currentTime + 5));
        }
        if (e.code === 'ArrowLeft') {
            e.preventDefault();
            const currentTime = wavesurfer.getCurrentTime();
            wavesurfer.setCurrentTime(Math.max(0, currentTime - 5));
        }
    });
</script>

</body>

</html>