<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图片排版水印保护</title>
    <style>
        .details-container {
            width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fff;
            padding: 20px 0;
        }

        .image-list {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .image-list img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .paste-tip {
            color: #888;
            margin-bottom: 10px;
        }

        p {
            color: #db0d0d;
            font-size: 16px;
            margin-top: 10px;
        }

        .controls {
            margin-bottom: 16px;
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls label {
            font-size: 14px;
        }

        .controls input[type="text"] {
            padding: 4px 8px;
            font-size: 14px;
            width: 200px;
        }

        button {
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        .save-btn {
            margin-top: 8px;
            font-size: 13px;
            padding: 4px 10px;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            color: white;
        }
    </style>
</head>

<body>
    <div class="details-container">
        <h1>图片排版水印保护</h1>
        <div class="paste-tip">可直接复制粘贴图片到此区域自动追加</div>

        <textarea id="mdInput" rows="6" style="width:90%;max-width:800px;margin-bottom:12px;"
            placeholder="粘贴Markdown图片链接，每行一个"></textarea>

        <div class="controls">
            <button id="parseMdBtn">解析并追加图片</button>
            <button id="copyAllBtn">一键复制全部图片</button>
            <button id="exportZipBtn">一键打包导出</button>
            <button id="clearBtn">清空</button>
            <label>
                <input type="checkbox" id="watermarkToggle" checked />
                添加水印
            </label>
            <label>
                水印文字：
                <input type="text" id="watermarkText" value="© 木子空间" />
            </label>
        </div>

        <p></p>
        <div class="image-list" id="imageList"></div>
    </div>

    <!-- 依赖库 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        let imageCount = 1;

        function addImageWithSaveButton(src) {
            const imageList = document.getElementById('imageList');

            const label = document.createElement('div');
            label.textContent = `图${imageCount}`;
            label.style = "font-weight:bold;font-size:16px;margin:16px 0 8px 0;width:100%;text-align:left;";
            imageList.appendChild(label);

            const img = document.createElement('img');
            img.src = src;

            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.flexDirection = 'column';
            wrapper.style.alignItems = 'center';
            wrapper.appendChild(img);

            const saveBtn = document.createElement('button');
            saveBtn.textContent = '保存该图';
            saveBtn.className = 'save-btn';
            saveBtn.onclick = () => saveSingleImage(img);
            wrapper.appendChild(saveBtn);

            imageList.appendChild(wrapper);
            imageCount++;
        }

        document.getElementById('parseMdBtn').onclick = function () {
            const mdText = document.getElementById('mdInput').value;
            const regex = /!\[.*?\]\((.*?)\)/g;
            let match;
            while ((match = regex.exec(mdText)) !== null) {
                addImageWithSaveButton(match[1]);
            }
        };

        document.querySelector('.details-container').addEventListener('paste', function (e) {
            const items = (e.clipboardData || window.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const file = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        addImageWithSaveButton(event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        document.getElementById('copyAllBtn').onclick = function () {
            exportFullImageToClipboardOrDownload(true);
        };

        function saveSingleImage(imgElement) {
            renderCanvasWithWatermark(imgElement).then(canvas => {
                canvas.toBlob(blob => {
                    const link = document.createElement('a');
                    link.download = 'image-' + Date.now() + '.png';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                });
            });
        }

        function renderCanvasWithWatermark(imgElement) {
            return new Promise((resolve, reject) => {
                const addWatermark = document.getElementById('watermarkToggle').checked;
                const watermarkText = document.getElementById('watermarkText').value || '© 木子空间';

                if (!imgElement || !imgElement.src) {
                    console.warn('传入的 imgElement 无效或没有 src：', imgElement);
                    reject(new Error('传入的 imgElement 无效或未加载完成'));
                    return;
                }

                const image = new Image();
                image.crossOrigin = 'anonymous';
                image.src = imgElement.src;

                image.onload = function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.width;
                    canvas.height = image.height;
                    const ctx = canvas.getContext('2d');

                    ctx.drawImage(image, 0, 0);

                    if (addWatermark) {
                        ctx.save();
                        ctx.rotate(-Math.PI / 6);
                        ctx.font = 'bold 60px Arial';
                        ctx.fillStyle = 'rgba(200,0,0,0.08)';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        const xStep = 400;
                        const yStep = 300;
                        for (let x = -canvas.width; x < canvas.width * 2; x += xStep) {
                            for (let y = -canvas.height; y < canvas.height * 2; y += yStep) {
                                ctx.fillText(watermarkText, x, y);
                            }
                        }

                        ctx.restore();
                    }

                    resolve(canvas);
                };

                image.onerror = function () {
                    reject(new Error('图片加载失败，可能跨域或链接失效'));
                };
            });
        }



        function exportFullImageToClipboardOrDownload(toClipboard = false) {
            const imageList = document.getElementById('imageList');
            renderCanvasWithWatermark(imageList).then(canvas => {
                canvas.toBlob(async blob => {
                    if (toClipboard && navigator.clipboard && window.ClipboardItem) {
                        try {
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            document.querySelector('p').innerText = '已复制全部图片到剪贴板（含/不含水印）';
                        } catch {
                            document.querySelector('p').innerText = '复制失败，已改为下载图片';
                            saveAs(blob, 'all-images.png');
                        }
                    } else {
                        saveAs(blob, 'all-images.png');
                    }
                });
            });
        }

        document.getElementById('exportZipBtn').onclick = async function () {
            const zip = new JSZip();
            const allImgs = document.querySelectorAll('#imageList img');

            for (let i = 0; i < allImgs.length; i++) {
                const img = allImgs[i];
                try {
                    const canvas = await renderCanvasWithWatermark(img);
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    zip.file(`img${i + 1}.png`, blob);
                } catch (e) {
                    console.error(`图 ${i + 1} 加水印失败：`, e);
                }
            }

            // 拼图仍使用 html2canvas 截图容器
            try {
                const fullImageContainer = document.getElementById('imageList');
                const fullCanvas = await html2canvas(fullImageContainer, {
                    backgroundColor: '#fff',
                    useCORS: true
                });

                const ctx = fullCanvas.getContext('2d');
                const watermarkText = document.getElementById('watermarkText').value || '© 木子空间';
                const addWatermark = document.getElementById('watermarkToggle').checked;

                if (addWatermark) {
                    ctx.save();
                    ctx.rotate(-Math.PI / 6);
                    ctx.font = 'bold 60px Arial';
                    ctx.fillStyle = 'rgba(200,0,0,0.08)';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    const xStep = 400;
                    const yStep = 300;
                    for (let x = -fullCanvas.width; x < fullCanvas.width * 2; x += xStep) {
                        for (let y = -fullCanvas.height; y < fullCanvas.height * 2; y += yStep) {
                            ctx.fillText(watermarkText, x, y);
                        }
                    }

                    ctx.restore();
                }

                const fullBlob = await new Promise(resolve => fullCanvas.toBlob(resolve, 'image/png'));
                zip.file(`all-images.png`, fullBlob);
            } catch (e) {
                console.error('拼图加水印失败：', e);
            }

            zip.generateAsync({ type: "blob" }).then(content => {
                saveAs(content, "images.zip");
            });
        };



        document.getElementById('clearBtn').onclick = function () {
            document.getElementById('mdInput').value = '';
            document.getElementById('imageList').innerHTML = '';
            document.querySelector('p').innerText = '';
            imageCount = 1;
        };
    </script>
</body>

</html>